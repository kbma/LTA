<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestion des Marges</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f7fa;
            min-height: 100vh;
        }

        .navbar {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            padding: 15px 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .navbar-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .navbar h1 {
            font-size: 24px;
        }

        .nav-links a {
            color: white;
            text-decoration: none;
            margin-left: 20px;
            padding: 8px 16px;
            border-radius: 5px;
            transition: background 0.3s;
        }

        .nav-links a:hover {
            background: rgba(255,255,255,0.2);
        }

        .container {
            max-width: 1200px;
            margin: 30px auto;
            padding: 0 20px;
        }

        .page-header {
            margin-bottom: 30px;
        }

        .page-header h2 {
            color: #333;
            font-size: 28px;
        }

        .card {
            background: white;
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .card h3 {
            color: #333;
            margin-bottom: 20px;
            font-size: 20px;
            border-bottom: 2px solid #e0e0e0;
            padding-bottom: 10px;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            color: #333;
            font-weight: 600;
            margin-bottom: 8px;
            font-size: 14px;
        }

        input[type="text"],
        input[type="number"],
        select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        input[type="text"]:focus,
        input[type="number"]:focus,
        select:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn-submit {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            background: #f8f9fa;
            color: #333;
            font-weight: 600;
            padding: 15px;
            text-align: left;
            border-bottom: 2px solid #e0e0e0;
        }

        td {
            padding: 15px;
            border-bottom: 1px solid #e0e0e0;
        }

        tr:hover {
            background: #f8f9fa;
        }

        .badge {
            padding: 5px 12px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: 600;
        }

        .badge.global {
            background: #667eea;
            color: white;
        }

        .badge.hotel {
            background: #28a745;
            color: white;
        }

        .badge.room {
            background: #ffc107;
            color: #333;
        }

        .btn-delete {
            padding: 6px 12px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            background: #dc3545;
            color: white;
        }

        .info-box {
            background: #f0f4ff;
            border-left: 4px solid #667eea;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 5px;
        }

        .info-box h4 {
            color: #667eea;
            font-size: 14px;
            margin-bottom: 8px;
        }

        .info-box p {
            color: #666;
            font-size: 13px;
            line-height: 1.5;
        }

        @media (max-width: 768px) {
            .form-grid {
                grid-template-columns: 1fr;
            }

            table {
                font-size: 12px;
            }

            th, td {
                padding: 10px 5px;
            }
        }
    </style>
</head>
<body>
    <div class="navbar">
        <div class="navbar-content">
            <h1>üí∞ Gestion des Marges</h1>
            <div class="nav-links">
                <a href="/admin/dashboard">Tableau de bord</a>
                <a href="/admin/conventions">Conventions</a>
                <a href="/admin/codes">Codes</a>
                <a href="/admin/logout">D√©connexion</a>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="page-header">
            <h2>üí∞ Gestion des Marges</h2>
        </div>

        <div class="info-box">
            <h4>‚ÑπÔ∏è Comment fonctionnent les marges ?</h4>
            <p>Les marges sont appliqu√©es aux prix de base avant le calcul de la r√©duction. Vous pouvez d√©finir une marge globale qui s'applique √† tous les h√¥tels, ou des marges sp√©cifiques par h√¥tel ou par type de chambre.</p>
        </div>

        <!-- Formulaire de cr√©ation de marge -->
        <div class="card">
            <h3>Ajouter/Modifier une marge</h3>
            <form action="/admin/margins/save" method="POST">
                <div class="form-grid">
                    <div class="form-group">
                        <label>Type de marge *</label>
                        <select name="margin_type" id="margin_type" required onchange="toggleEntityId()">
                            <option value="global">Marge globale</option>
                            <option value="hotel">Marge par h√¥tel</option>
                            <option value="room_type">Marge par type de chambre</option>
                        </select>
                    </div>

                    <div class="form-group" id="entity_id_group" style="display: none;">
                        <label>ID de l'entit√©</label>
                        <input type="text" name="entity_id" id="entity_id" placeholder="Ex: 1 pour h√¥tel ID 1">
                        <small style="color: #666;">Laissez vide pour la marge globale</small>
                    </div>

                    <div class="form-group">
                        <label>Valeur de la marge *</label>
                        <input type="number" name="margin_value" step="0.01" required>
                    </div>

                    <div class="form-group">
                        <label>Unit√© *</label>
                        <select name="margin_unit" required>
                            <option value="percentage">Pourcentage (%)</option>
                            <option value="fixed">Montant fixe (‚Ç¨)</option>
                        </select>
                    </div>
                </div>

                <div class="form-grid">
                    <div class="form-group">
                        <label>Date de d√©but de validit√©</label>
                        <input type="date" name="valid_from">
                        <small style="color: #666;">Laissez vide pour validit√© imm√©diate</small>
                    </div>

                    <div class="form-group">
                        <label>Date de fin de validit√©</label>
                        <input type="date" name="valid_until">
                        <small style="color: #666;">Laissez vide pour validit√© illimit√©e</small>
                    </div>

                    <div class="form-group">
                        <label>Statut</label>
                        <select name="is_active">
                            <option value="1">Active</option>
                            <option value="0">Inactive</option>
                        </select>
                    </div>
                </div>

                <button type="submit" class="btn-submit">Enregistrer la marge</button>
            </form>
        </div>

        <!-- Liste des marges existantes -->
        <div class="card">
            <h3>Marges configur√©es</h3>
            <% if (margins.length > 0) { %>
                <table>
                    <thead>
                        <tr>
                            <th>Type</th>
                            <th>ID Entit√©</th>
                            <th>Valeur</th>
                            <th>Unit√©</th>
                            <th>Validit√©</th>
                            <th>Statut</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <% margins.forEach(margin => { 
                            const now = new Date();
                            const validFrom = margin.valid_from ? new Date(margin.valid_from) : null;
                            const validUntil = margin.valid_until ? new Date(margin.valid_until) : null;
                            const isActive = margin.is_active !== 0 && (!validFrom || validFrom <= now) && (!validUntil || validUntil >= now);
                        %>
                            <tr>
                                <td>
                                    <span class="badge <%= margin.margin_type %>">
                                        <%= margin.margin_type === 'global' ? 'Globale' : 
                                            margin.margin_type === 'hotel' ? 'H√¥tel' : 'Chambre' %>
                                    </span>
                                </td>
                                <td><%= margin.entity_id || 'Tous' %></td>
                                <td><strong><%= margin.margin_value %></strong></td>
                                <td><%= margin.margin_unit === 'percentage' ? 'Pourcentage (%)' : 'Fixe (‚Ç¨)' %></td>
                                <td>
                                    <small>
                                        <%= margin.valid_from ? 'Du ' + new Date(margin.valid_from).toLocaleDateString('fr-FR') : 'Illimit√©e' %>
                                        <%= margin.valid_until ? ' au ' + new Date(margin.valid_until).toLocaleDateString('fr-FR') : '' %>
                                    </small>
                                </td>
                                <td>
                                    <span class="badge <%= isActive ? 'global' : 'room' %>" style="<%= isActive ? '' : 'background: #dc3545;' %>">
                                        <%= isActive ? 'Active' : 'Inactive' %>
                                    </span>
                                </td>
                                <td>
                                    <form action="/admin/margins/delete/<%= margin.id %>" method="POST" style="display: inline;" onsubmit="return confirm('Voulez-vous vraiment supprimer cette marge ?')">
                                        <button type="submit" class="btn-delete">Supprimer</button>
                                    </form>
                                </td>
                            </tr>
                        <% }); %>
                    </tbody>
                </table>
            <% } else { %>
                <p style="text-align: center; color: #999; padding: 20px;">
                    Aucune marge configur√©e. Ajoutez-en une ci-dessus.
                </p>
            <% } %>
        </div>
    </div>

    <script>
        function toggleEntityId() {
            const marginType = document.getElementById('margin_type').value;
            const entityIdGroup = document.getElementById('entity_id_group');
            
            if (marginType === 'global') {
                entityIdGroup.style.display = 'none';
                document.getElementById('entity_id').value = '';
            } else {
                entityIdGroup.style.display = 'block';
            }
        }

        // Initialiser l'affichage au chargement
        toggleEntityId();
    </script>
</body>
</html>
